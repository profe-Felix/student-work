<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Syllable Train</title>

<meta name="viewport"
content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<!-- QR Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  overscroll-behavior:none;
}

body{
  font-family:Andika,system-ui,sans-serif;
  background:#fff;
  -webkit-user-select:none;
  user-select:none;
}

/* scroll container */
#frame{
  width:100%;
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}

/* main stage (drag surface) */
#stage{
  padding:10px;
  min-width:0;
  touch-action:none;
}


/* Desktop boost */
@media (hover:hover){
  #stage{
    transform:scale(1.35);
    transform-origin:center top;
  }
}


#trainRow{
  display:flex;
  align-items:flex-start;
}

#rail{
  display:flex;
  align-items:flex-end;
  justify-content:flex-start;
}

/* Controls */

#slotControls{
  display:flex;
  flex-direction:column;
  gap:6px;
  align-items:center;
  margin-right:12px;
  position:relative;
  z-index:10;
}

.ctrlBtn{
  width:36px;
  height:30px;
  border:2px solid #cbd5e1;
  border-radius:10px;
  background:#f8fafc;
  color:#2563eb;
  font-size:16px;
  box-shadow:0 2px 0 rgba(0,0,0,.08);
  cursor:pointer;
  touch-action:manipulation;
}

/* Engine */

#engine{
  width:300px;
  height:140px;
  background:url("train.png") center bottom/contain no-repeat;
  flex-shrink:0;
  margin-right:-70px;
  pointer-events:none;
}


/* Slots */

#slotsWrap{
  display:flex;
  margin-left:0px;
}

.slot{
  width:120px;
  height:60px;
  border:2px dashed #bbb;
  border-radius:12px;
  position:relative;
}

/* Sources */

#sources{
  margin-top:26px;
  display:flex;
  gap:28px;
  justify-content:center;
}

.source{
  width:120px;
  height:60px;
  cursor:grab;
  touch-action:none;
}

.source.red{background:url("redtraincar.png") center/contain no-repeat}
.source.blue{background:url("bluetraincar.png") center/contain no-repeat}

/* Cars */

.car{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background-size:100% 100%;
  background-position:center;
  background-repeat:no-repeat;
}

.car.red{background-image:url("redtraincar.png")}
.car.blue{background-image:url("bluetraincar.png")}

/* Drag ghost */

.dragGhost{
  position:fixed;
  width:120px;
  height:60px;
  transform:translate(-50%,-50%);
  pointer-events:none;
  z-index:9999;
}
</style>
</head>

<body>

<div id="frame">
<div id="stage">

<div id="trainRow">

<div id="slotControls">
<button class="ctrlBtn" id="btnUp" type="button">‚¨ÜÔ∏è</button>
<button class="ctrlBtn" id="btnDown" type="button">‚¨áÔ∏è</button>
<button class="ctrlBtn" id="btnQR" type="button">üì±</button>
<div>Slots: <span id="slotCount"></span></div>
</div>

<div id="rail">
<div id="engine"></div>
<div id="slotsWrap"></div>
</div>

</div>

<div id="sources">
<div class="source red" data-color="red"></div>
<div class="source blue" data-color="blue"></div>
</div>

</div>
</div>

<!-- QR Overlay -->
<div id="qrOverlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99999;
">
  <div style="
    background:#fff;
    padding:20px 22px;
    border-radius:16px;
    text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  ">
    <div style="font-size:18px;margin-bottom:10px">Student QR</div>
    <div id="qrBox"></div>
    <button id="qrClose" class="ctrlBtn" style="margin-top:12px">Close</button>
  </div>
</div>

<script>
const frame = document.getElementById("frame");
const slotsWrap = document.getElementById("slotsWrap");
const slotCountEl = document.getElementById("slotCount");
const btnUp = document.getElementById("btnUp");
const btnDown = document.getElementById("btnDown");
const btnQR = document.getElementById("btnQR");
const qrOverlay = document.getElementById("qrOverlay");
const qrBox = document.getElementById("qrBox");
const qrClose = document.getElementById("qrClose");

let qrInstance=null;

btnQR.addEventListener("click",()=>{
  qrOverlay.style.display="flex";
  qrBox.innerHTML="";
  qrInstance=new QRCode(qrBox,{
    text:location.href,
    width:220,
    height:220
  });
});

qrClose.addEventListener("click",()=>{
  qrOverlay.style.display="none";
  qrBox.innerHTML="";
});

let slotCount = 4;
const MIN = 1, MAX = 12;

function centerFrame(){
  const maxScroll = frame.scrollWidth - frame.clientWidth;
  frame.scrollLeft = maxScroll > 0 ? Math.round(maxScroll/2) : 0;
}

function renderSlots(){
  const keep=[...slotsWrap.children].map(s=>s.firstChild);
  slotsWrap.innerHTML="";
  for(let i=0;i<slotCount;i++){
    const s=document.createElement("div");
    s.className="slot";
    if(keep[i]) s.appendChild(keep[i]);
    slotsWrap.appendChild(s);
  }
  slotCountEl.textContent=slotCount;
  requestAnimationFrame(centerFrame);
}

btnUp.addEventListener("pointerdown",e=>{
  e.preventDefault();
  if(slotCount<MAX){slotCount++;renderSlots();}
});

btnDown.addEventListener("pointerdown",e=>{
  e.preventDefault();
  if(slotCount>MIN){slotCount--;renderSlots();}
});

renderSlots();
window.addEventListener("resize",()=>requestAnimationFrame(centerFrame));

/* ---- Drag ---- */

let dragging=null; // { ghost, fromSlot }

function makeCar(color){
  const c=document.createElement("div");
  c.className="car "+color;

  c.addEventListener("pointerdown",e=>{
    e.preventDefault();
    startExisting(e,c);
  });

  return c;
}

function startExisting(e,car){
  e.preventDefault();

  const slots=[...document.querySelectorAll(".slot")];
  const idx=slots.findIndex(s=>s.firstChild===car);

  dragging={
    ghost:car,
    fromSlot:idx
  };

  car.remove();
  car.classList.add("dragGhost");
  document.body.appendChild(car);
  move(e);
}

document.querySelectorAll(".source").forEach(src=>{
  src.addEventListener("pointerdown",e=>{
    e.preventDefault();
    const g=makeCar(src.dataset.color);
    g.classList.add("dragGhost");
    document.body.appendChild(g);
    dragging={ghost:g,fromSlot:-1};
    move(e);
  });
});

function move(e){
  if(!dragging) return;
  dragging.ghost.style.left=e.clientX+"px";
  dragging.ghost.style.top=e.clientY+"px";
}

/* CRITICAL: non-passive so Safari can't scroll */
document.addEventListener("pointermove",e=>{
  if(dragging){
    e.preventDefault();
    move(e);
  }
},{passive:false});

document.addEventListener("pointerup",e=>{
  if(!dragging) return;

  const slots=[...document.querySelectorAll(".slot")];
  const x=e.clientX;

  // remove ghost styling immediately (Safari safety)
  dragging.ghost.classList.remove("dragGhost");
  dragging.ghost.style.left="";
  dragging.ghost.style.top="";

  // capture cars INCLUDING empties (preserve slot structure)
  let cars=slots.map(s=>s.firstChild || null);

  const from=dragging.fromSlot;

  // remove dragged car from its original place
  if(from>-1) cars[from]=null;

  // nearest slot center
  let bestSlot=-1,slotDist=9999;

  slots.forEach((s,i)=>{
    const r=s.getBoundingClientRect();
    const cx=r.left+r.width/2;
    const d=Math.abs(x-cx);
    if(d<slotDist){
      slotDist=d;
      bestSlot=i;
    }
  });

  // couplers INCLUDING engine -> first slot
  let coupler=0,cDist=9999;

  // engine coupler
  if(slots[0]){
    const r=slots[0].getBoundingClientRect();
    const d=Math.abs(x-(r.left-30));
    cDist=d;
    coupler=0;
  }

  // middle couplers
  for(let i=0;i<slots.length-1;i++){
    const a=slots[i].getBoundingClientRect();
    const b=slots[i+1].getBoundingClientRect();
    const mid=(a.right+b.left)/2;
    const d=Math.abs(x-mid);
    if(d<cDist){
      cDist=d;
      coupler=i+1;
    }
  }

  const COUPLER=40;

  // SOURCE ‚Üí insert (grow train) ONLY if coupling next to a car
  if(dragging.fromSlot===-1 && cDist<COUPLER && slotCount<MAX){

  const left=coupler>0 ? cars[coupler-1] : null;
  const right=cars[coupler] || null;

  // only grow if at least one neighbor has a car
  if(left || right){
    cars.splice(coupler,0,dragging.ghost);
    slotCount++;
  }else{
    // otherwise snap into nearest empty slot
    if(bestSlot>-1) cars[bestSlot]=dragging.ghost;
  }
}


  // SLOT ‚Üí swap
  else if(from>-1 && bestSlot>-1){
    const tmp=cars[bestSlot];
    cars[bestSlot]=dragging.ghost;
    if(tmp) cars[from]=tmp;
  }

  // simple drop into empty slot
  else if(bestSlot>-1){
    cars[bestSlot]=dragging.ghost;
  }

  // dropped in white space ‚Üí delete
  else{
    dragging.ghost.remove();
    dragging=null;
    renderSlots();
    return;
  }

  // rebuild slots
  renderSlots();

  const newSlots=[...document.querySelectorAll(".slot")];
  newSlots.forEach((s,i)=>{
    s.innerHTML="";
    if(cars[i]) s.appendChild(cars[i]);
  });

  dragging=null;
});


</script>


</body>
</html>




