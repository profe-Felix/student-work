<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clasificador de letras â€” Maestro & Estudiante</title>

  <!-- Kid-friendly font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Preconnect to Supabase for faster fetches -->
  <link rel="preconnect" href="https://dmlsiyyqpcupbizpxwhp.supabase.co" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    :root{--bg:#f7f7fb;--ink:#111;--muted:#666;--brand:#2563eb;--ok:#16a34a;--bad:#dc2626;--card:#fff;--drop:#eef2ff}
    html,body{height:100%}
    body{margin:0;font:16px/1.45 Andika, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:5}
    .row{display:flex;gap:12px;align-items:center}
    .brand{font-weight:700}
    .spacer{flex:1}
    .switch{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .panel{margin-top:10px}
    .panel.hidden{display:none}
    .grid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;align-items:end}
    .field{margin:6px 0}
    .field .inline{display:flex;gap:8px}
    input,button{font:inherit}
    input{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;width:100%}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:var(--brand);color:#fff;cursor:pointer}
    .btn.outline{background:#fff;border-color:#d1d5db;color:#111}
    .btn.ghost{background:transparent;border-color:transparent;color:#666}
    .buttons{display:flex;gap:8px;align-items:center}
    .note{font-size:12px;color:#666;margin-top:8px}
    .letters{display:flex;flex-wrap:wrap;gap:6px}
    .letters button{min-width:36px;height:36px;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    .letters button.active{background:var(--brand);color:#fff;border-color:transparent}

    main{max-width:1100px;margin:14px auto;padding:0 12px}

    /* One-row columns */
    .columns{
      display:grid;
      gap:16px;
      margin-top:16px;
      overflow-x:auto;
      scroll-snap-type:x proximity;
    }
    .col{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);padding:10px;scroll-snap-align:start}
    .col header{display:flex;align-items:center;justify-content:center;margin-bottom:10px}

    /* Syllable tile */
    .syllTile{
      min-width:110px;min-height:78px;padding:10px 14px;
      background:#6dd0ff;color:#000;font-size:38px;line-height:1;border-radius:18px;
      display:flex;align-items:center;justify-content:center;box-shadow:inset 0 0 0 2px rgba(0,0,0,.05);
      user-select:none;
    }

    .drop{
      min-height:240px;background:var(--drop);border:2px dashed #c7d2fe;border-radius:12px;
      padding:8px;display:flex;flex-wrap:wrap;gap:8px;align-content:flex-start;align-items:stretch
    }

    .rackSection{margin-top:18px}
    .rack{margin-top:8px;background:#fff;border:1px dashed #e5e7eb;border-radius:12px;padding:10px;display:flex;flex-wrap:wrap;gap:8px;min-height:150px}

    .card{
      user-select:none;touch-action:none;background:var(--card);border:1px solid #e5e7eb;border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.06);width:150px;overflow:hidden;cursor:grab;display:flex;flex-direction:column;align-items:center
    }
    .card:active{cursor:grabbing}

    .card img{
      display:block;width:100%;
      aspect-ratio: 4/3; object-fit: contain; background:#fafafa
    }
    .card .cap{padding:6px 8px;width:100%;text-align:center;font-size:14px}
    .card.ok{outline:3px solid var(--ok)}
    .card.bad{outline:3px solid var(--bad)}
    .locked{opacity:.9}

    /* Grow only after drop AND only when percategory=1 */
    .one-per .drop .card{width:100%}

    /* While dragging, keep a fixed size (no giant cards when moving) */
    .card.dragging{width:150px !important; height:auto !important}

    .warn{padding:10px 12px;border:1px solid #fecaca;background:#fef2f2;border-radius:10px;color:#b91c1c}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-size:12px;margin-left:8px}

    /* Solo toolbar */
    .soloBar{position:sticky;top:56px;z-index:4;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;display:flex;gap:8px;align-items:center;box-shadow:0 4px 10px rgba(0,0,0,.04)}

    /* Verify under the bank */
    .bankActions{display:flex;gap:8px;align-items:center;margin-top:10px}

    .celebrationCanvas{position:fixed;inset:0;pointer-events:none;z-index:50}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">Clasificador de letras</div>
        <span id="soloPill" class="pill" style="display:none"></span>
        <div class="spacer"></div>
        <label class="switch">
          <input id="modeToggle" type="checkbox" />
          <span>Modo Maestro</span>
        </label>
      </div>

      <!-- Maestro -->
      <div id="teacherPanel" class="panel hidden">
        <div class="field">
          <label>CÃ³digo de sesiÃ³n</label>
          <div class="inline">
            <input id="roomCode" placeholder="por ej., A_01" />
            <button id="btnJoin" class="btn">Iniciar sesiÃ³n</button>
          </div>
          <small class="note">Comparte este cÃ³digo con los estudiantes.</small>
        </div>

        <div class="grid">
          <div>
            <label>Letras objetivo (1â€“5)</label>
            <div id="letterPicker" class="letters"></div>
          </div>
          <div>
            <label>Cartas por columna</label>
            <input id="cardsPerCol" type="number" min="1" max="8" value="4" />
          </div>
          <div class="buttons">
            <button id="btnNewRound" class="btn">Nueva ronda</button>
            <button id="btnVerify" class="btn outline">Verificar</button>
            <button id="btnReset" class="btn ghost">Reiniciar ronda</button>
          </div>
        </div>

        <div class="note">
          Las imÃ¡genes y audios se cargan de <strong>Supabase Storage</strong>.
          <div id="storageWarn" class="warn" style="display:none"></div>
        </div>
      </div>

      <!-- Estudiante -->
      <div id="studentPanel" class="panel">
        <div class="field inline">
          <input id="studentRoom" placeholder="CÃ³digo de sesiÃ³n" />
          <button id="btnStudentJoin" class="btn">Unirse</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- SOLO TOOLBAR -->
    <div id="soloBar" class="soloBar hidden">
      <button id="soloNewRound" class="btn">Nueva ronda</button>
      <button id="soloVerify" class="btn outline">Verificar</button>
      <button id="soloReset" class="btn ghost">Reiniciar ronda</button>
    </div>

    <div id="columns" class="columns"></div>

    <section class="rackSection">
      <h3>Cartas</h3>
      <div id="rack" class="rack" aria-label="rack"></div>
      <div class="bankActions">
        <button id="inlineVerify" class="btn outline">Verificar</button>
        <button id="inlineReset" class="btn ghost">Reiniciar ronda</button>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /******** SUPABASE CONFIG ********/
    const SUPABASE_URL = "https://dmlsiyyqpcupbizpxwhp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbHNpeXlxcGN1cGJpenB4d2hwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MDI1NjUsImV4cCI6MjA3Mzk3ODU2NX0.mkgeUtjC8ulLyHHVVOic4LmhhQP_JJtMi2JQztdzjsg";

    const IMAGES_BUCKET = "lettersort-images";
    const AUDIO_BUCKET  = "lettersort-audio";
    const IMAGES_PREFIX = "";
    const AUDIO_PREFIX  = "";

    // URL params
    const qs = new URLSearchParams(location.search);
    const IB = qs.get('ib') || IMAGES_BUCKET;
    const AB = qs.get('ab') || AUDIO_BUCKET;
    const IP = qs.get('ip') || IMAGES_PREFIX;
    const AP = qs.get('ap') || AUDIO_PREFIX;

    const SOLO_LETTERS   = (qs.get('letters')   || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
    const SOLO_SYLLABLES = (qs.get('syllables') || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
    const SOLO_PER  = Math.max(1, Math.min(8, parseInt(qs.get('percategory') || qs.get('per') || '0', 10) || 0));
    const SOLO_WORDS= (qs.get('words') || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
    const HIDE_TITLE = (qs.get('hidetitle') || '').toLowerCase() === 'true';
    const LABEL_STYLE = (qs.get('labelstyle') || 'classic').toLowerCase(); // classic | emoji

    const SOLO_MODE = (SOLO_LETTERS.length > 0) || (SOLO_SYLLABLES.length > 0);

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /******** UI refs ********/
    const storageWarn = document.getElementById('storageWarn');
    const modeToggle = document.getElementById('modeToggle');
    const teacherPanel = document.getElementById('teacherPanel');
    const studentPanel = document.getElementById('studentPanel');
    const btnJoin = document.getElementById('btnJoin');
    const roomCodeEl = document.getElementById('roomCode');
    const studentRoomEl = document.getElementById('studentRoom');
    const btnStudentJoin = document.getElementById('btnStudentJoin');
    const letterPicker = document.getElementById('letterPicker');
    const cardsPerColEl = document.getElementById('cardsPerCol');
    const columnsEl = document.getElementById('columns');
    const rackEl = document.getElementById('rack');
    const btnNewRound = document.getElementById('btnNewRound');
    const btnVerify = document.getElementById('btnVerify');
    const btnReset = document.getElementById('btnReset');
    const soloPill = document.getElementById('soloPill');

    // Solo toolbar refs
    const soloBar = document.getElementById('soloBar');
    const soloNewRoundBtn = document.getElementById('soloNewRound');
    const soloVerifyBtn   = document.getElementById('soloVerify');
    const soloResetBtn    = document.getElementById('soloReset');

    // Inline (under bank)
    const inlineVerifyBtn = document.getElementById('inlineVerify');
    const inlineResetBtn  = document.getElementById('inlineReset');

    /******** State ********/
    let ROOM = null, channel = null, isTeacher = false;
    let imageFiles = []; // [{name, path, url, stem, core, initial}]
    let audioMap = new Map(); // core -> audio URL
    let currentCols = [], currentCards = [], usedSet = new Set();

    function setPanelsForSolo() {
      teacherPanel.classList.add('hidden');
      studentPanel.classList.add('hidden');
      document.querySelector('.switch').classList.add('hidden');

      // Toggle stretch style based on percategory
      document.body.classList.toggle('one-per', (SOLO_PER || 4) === 1);

      if (SOLO_MODE) {
        const per = SOLO_PER || 4;
        const modeTxt = SOLO_SYLLABLES.length
          ? `sÃ­labas=${SOLO_SYLLABLES.join(', ')}`
          : `letras=${SOLO_LETTERS.join(', ')}`;
        const wordsTxt = SOLO_WORDS.length ? ` Â· palabras=${SOLO_WORDS.join(', ')}` : '';
        const labelTxt = LABEL_STYLE==='emoji' ? ' Â· etiquetas: emoji' : '';
        const hideTxt = HIDE_TITLE ? ' Â· sin tÃ­tulo' : '';
        soloPill.style.display = 'inline-block';
        soloPill.textContent = `Modo individual: ${modeTxt} Â· ${per} por columna${wordsTxt}${labelTxt}${hideTxt}`;
        soloBar.classList.remove('hidden');
      }
    }

    modeToggle.addEventListener('change', () => {
      isTeacher = modeToggle.checked;
      teacherPanel.classList.toggle('hidden', !isTeacher);
      studentPanel.classList.toggle('hidden', isTeacher);
    });

    const LETTERS = 'a,b,c,ch,d,e,f,g,h,i,j,k,l,ll,m,n,Ã±,o,p,q,r,rr,s,t,u,v,w,x,y,z'.split(',');
    function renderLetterPicker(){
      letterPicker.innerHTML='';
      LETTERS.forEach(L=>{
        const b=document.createElement('button');
        b.type='button'; b.textContent=L;
        b.addEventListener('click', ()=>{
          b.classList.toggle('active');
          const act=[...letterPicker.querySelectorAll('.active')];
          if(act.length>5) b.classList.remove('active');
        });
        letterPicker.appendChild(b);
      });
    }
    renderLetterPicker();

    /******** Helpers (accents/markers & syllables) ********/
    function markersToPretty(s){
      return (s||'')
        .replace(/a\.\./g,'Ã¡').replace(/e\.\./g,'Ã©').replace(/i\.\./g,'Ã­').replace(/o\.\./g,'Ã³').replace(/u\.\./g,'Ãº')
        .replace(/n\.\./g,'Ã±').replace(/u,,/g,'Ã¼');
    }
    function normalizePlain(s){
      return (s||'').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/Ã±/g,'n').replace(/Ã¼/g,'u').replace(/[^a-z]/g,'');
    }
    function extOf(name){ const i=name.lastIndexOf('.'); return i>=0 ? name.slice(i+1).toLowerCase() : ''; }
    function stemOf(name){ const i=name.lastIndexOf('.'); return i>=0 ? name.slice(0,i) : name; }
    function normalizeMarkers(s){
      let t = (s || '').toLowerCase().trim();
      t = t.replace(/a\.\./g,'a').replace(/e\.\./g,'e').replace(/i\.\./g,'i').replace(/o\.\./g,'o').replace(/u\.\./g,'u');
      t = t.replace(/u,,/g,'u').replace(/n\.\./g,'n');
      t = t.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      return t;
    }
    function stripImageSuffix(t){ return t.replace(/_(pic|img|image|foto)$/i,''); }
    function coreFromImageStem(stem){ return normalizeMarkers(stripImageSuffix(stem)); }
    function coreFromAudioStem(stem){ return normalizeMarkers(stem); }
    function initialFromStem(stemRaw){
      const raw = (stemRaw || '').toLowerCase();
      if(raw.startsWith('n..')) return 'Ã±';
      const s = normalizeMarkers(raw);
      if(s.startsWith('ch')) return 'ch';
      if(s.startsWith('ll')) return 'll';
      if(s.startsWith('rr')) return 'rr';
      return s[0] || '';
    }

    /* syllabify + first syllable (same rules as Elkonin app) */
    function syllabifyEs(wordRaw){
      const word = (wordRaw || '').toLowerCase();
      const isV = ch => /[aeiouÃ¡Ã©Ã­Ã³ÃºÃ¼]/.test((ch||'')[0] || '');
      const isWeakUnaccented = ch => /^(i|u|Ã¼)$/.test((ch||'')[0] || '');
      const isAccWeak = ch => /[Ã­Ãº]/.test((ch||'')[0] || '');
      const onsetPairs = ['pl','pr','bl','br','tr','dr','cl','cr','gl','gr','fl','fr','ch','ll','rr'];

      const chars = [];
      for (let i=0;i<word.length;i++){
        const two = word.slice(i, i+2);
        if (['ch','ll','rr'].includes(two)) { chars.push(two); i++; continue; }
        if (word[i]==='q' && word[i+1]==='u' && /[eiÃ©Ã­]/.test(word[i+2]||'')) { chars.push('qu'); i++; continue; }
        if (word[i]==='g' && word[i+1]==='u' && /[eiÃ©Ã­]/.test(word[i+2]||'') && word[i+1]!=='Ã¼'){ chars.push('gu'); i++; continue; }
        chars.push(word[i]);
      }

      const syl = []; let i = 0;
      while (i < chars.length){
        let onset = [];
        while (i < chars.length && !isV(chars[i])) onset.push(chars[i++]);

        if (i >= chars.length){
          if (syl.length) syl[syl.length-1] += onset.join('');
          else syl.push(onset.join(''));
          break;
        }

        let nuc = [chars[i++]];
        for (let k = 0; k < 2 && i < chars.length && isV(chars[i]); k++){
          const prev = nuc[nuc.length-1], next = chars[i];
          const canJoin =
            ((isWeakUnaccented(prev) && !isAccWeak(prev)) && !isAccWeak(next)) ||
            ((isWeakUnaccented(next) && !isAccWeak(next)) && !isAccWeak(prev)) ||
            (isWeakUnaccented(prev) && isWeakUnaccented(next));
          if (canJoin) { nuc.push(next); i++; } else break;
        }

        let after = [];
        while (i < chars.length && !isV(chars[i])) after.push(chars[i++]);

        let coda = [], nextOnset = after.slice();
        if (nextOnset.length){
          let m = 0;
          while (nextOnset.length - m >= 2){
            const a = nextOnset[m], b = nextOnset[m+1];
            const pair = (a + b).replace(/[^a-zÃ±]/g,'');
            if (onsetPairs.includes(pair)) break;
            m++;
          }
          coda = nextOnset.slice(0, m);
          nextOnset = nextOnset.slice(m);
          while (nextOnset.length > 2) coda.push(nextOnset.shift());
        }

        syl.push(onset.join('') + nuc.join('') + coda.join(''));
        if (nextOnset.length) i -= nextOnset.length;
      }
      return syl.filter(Boolean).map(s => s.trim());
    }
    function firstSyllableNormalized(coreWord){
      const pretty = markersToPretty(coreWord);
      const first = syllabifyEs(pretty)[0] || '';
      return normalizePlain(first);
    }

    /******** Targeted image/audio helpers (speed-ups) ********/
    function normalizeNameForPath(s){
      return (s||'').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/Ã±/g,'n').replace(/Ã¼/g,'u')
        .replace(/[^a-z0-9_-]/g,'');
    }
    async function getPublicUrlIfExists(bucket, path){
      const { data } = client.storage.from(bucket).getPublicUrl(path);
      if(!data?.publicUrl) return null;
      try { const r = await fetch(data.publicUrl, { method:'HEAD' }); if(r.ok) return data.publicUrl; } catch {}
      return null;
    }
    function imageCandidates(word){
      const base = normalizeNameForPath(word);
      const prefix = IP ? `${IP.replace(/\/$/,'')}/` : '';
      const names = [
        `${word.toLowerCase()}_pic`, `${base}_pic`,
        `${word.toLowerCase()}`, `${base}`
      ];
      const exts = ['webp','jpg','jpeg','png','gif'];
      const paths = [];
      for (const n of names) for (const e of exts) paths.push(`${prefix}${n}.${e}`);
      return paths;
    }
    async function resolveImageForWord(word){
      for (const p of imageCandidates(word)) {
        const url = await getPublicUrlIfExists(IB, p);
        if (url) {
          const name = p.split('/').pop();
          const stem = name.replace(/\.[^.]+$/, '');
          return {
            name,
            path: p,
            url,
            stem,
            core: coreFromImageStem(stem),
            initial: initialFromStem(stem)
          };
        }
      }
      return null;
    }
    const AUDIO_EXTS_ROUND = ['webm','ogg','m4a','mp3','wav'];
    async function resolveAudioForCore(core){
      const prefix = AP ? `${AP.replace(/\/$/,'')}/` : '';
      for (const ext of AUDIO_EXTS_ROUND) {
        const p = `${prefix}${core}.${ext}`;
        const url = await getPublicUrlIfExists(AB, p);
        if (url) return url;
      }
      return null;
    }
    async function preloadAudioForCurrentCards(){
      const tasks = [];
      for (const c of currentCards){
        const core = coreFromAudioStem(c.word || '');
        if (audioMap.has(core)) continue;
        tasks.push((async ()=>{
          const url = await resolveAudioForCore(core);
          if (url) audioMap.set(core, url);
        })());
      }
      try { await Promise.allSettled(tasks); } catch {}
    }

    /******** Storage ********/
    async function listAll(bucket, prefix) {
      const path = prefix && prefix.trim() !== "" ? prefix : undefined;
      let out = [], offset = 0, limit = 100;
      while (true) {
        const { data, error } = await client.storage.from(bucket).list(path, {
          limit, offset, sortBy:{column:'name', order:'asc'}
        });
        if (error) throw error;
        const items = data || [];
        for (const it of items) {
          const fullpath = path ? `${path.replace(/\/$/,'')}/${it.name}` : it.name;
          out.push({ ...it, fullpath });
        }
        if (items.length < limit) break;
        offset += limit;
      }
      return out;
    }
    async function listAllImages(){
      const imgList = await listAll(IB, IP);
      const pubImg = [];
      for (const f of imgList) {
        const base = f.fullpath.split('/').pop() || f.fullpath;
        const e = extOf(base);
        if (!['png','jpg','jpeg','webp','gif'].includes(e)) continue;
        const { data } = client.storage.from(IB).getPublicUrl(f.fullpath);
        if (data?.publicUrl) {
          const stem = stemOf(base);
          pubImg.push({
            name: base, path: f.fullpath, url: data.publicUrl,
            stem, core: coreFromImageStem(stem), initial: initialFromStem(stem)
          });
        }
      }
      return pubImg;
    }

    async function ensureStorageLoaded(){
      try{
        imageFiles = [];
        if (SOLO_WORDS.length) {
          // Fast path: resolve only requested words; fallback to full list if none found
          const found = [];
          for (const w of SOLO_WORDS) {
            const f = await resolveImageForWord(w);
            if (f) found.push(f);
          }
          imageFiles = found.length ? found : await listAllImages();
        } else {
          imageFiles = await listAllImages();
        }

        // Do NOT scan entire audio bucket; we preload only for current round
        audioMap = new Map();

        storageWarn.style.display = imageFiles.length ? 'none' : 'block';
        if (!imageFiles.length){
          storageWarn.textContent = `No se encontraron imÃ¡genes en "${IB}" (prefijo: ${IP || '(raÃ­z)'}).`;
        }
      } catch(err){
        storageWarn.style.display = 'block';
        storageWarn.textContent = `Error al listar Storage: ${err?.message || err}`;
      }
    }

    /******** Realtime ********/
    async function joinRoom(room){
      if(channel){ try{ await channel.unsubscribe(); }catch{} }
      ROOM = (room||'').trim();
      if(!ROOM){ alert('CÃ³digo de sesiÃ³n invÃ¡lido'); return; }

      channel = client.channel(`lettersort:${ROOM}`);
      channel.on('broadcast', { event:'ROUND' }, p=>{
        const d=p.payload;
        buildColumns(d.columns);
        setCards(d.cards);
        clearAllPlacements();
      });
      channel.on('broadcast', { event:'VERIFY' }, ()=> verifyNow(true));
      channel.on('broadcast', { event:'RESET' }, ()=> resetRoundPlacements());

      const { error } = await channel.subscribe();
      if(error){ alert('Error de Realtime'); console.error(error); }
    }

    btnJoin.addEventListener('click', async ()=>{
      const room = roomCodeEl.value || 'A_01';
      await joinRoom(room);
      await ensureStorageLoaded();
    });
    btnStudentJoin.addEventListener('click', async ()=>{
      const room = studentRoomEl.value || 'A_01';
      await joinRoom(room);
    });

    /******** Labels (modular) ********/
    function labelTextFor(letter, type){
      // type: 'is' | 'not'
      if (LABEL_STYLE === 'emoji') {
        return type==='is' ? `ðŸ‘ SÃ­laba con /${letter}/` : `ðŸ‘Ž SÃ­laba sin /${letter}/`;
      }
      // classic
      return type==='is' ? `Empieza con /${letter}/` : `No empieza con /${letter}/`;
    }

    function buildColumnsForLetters(activeLetters){
      const columns = [];
      if(activeLetters.length===1){
        const L = activeLetters[0];
        columns.push({label:labelTextFor(L,'is'),  key:`${L}`});
        columns.push({label:labelTextFor(L,'not'), key:`not-${L}`});
      } else {
        activeLetters.forEach(L=> columns.push({label:labelTextFor(L,'is'), key:`${L}`}));
      }
      return columns;
    }
    function buildColumnsForSyllables(sylls){
      return sylls.map(s => ({ label: s, key:`syll:${normalizePlain(s)}`, display:s }));
    }

    /******** Round building ********/
    function buildRoundFromLetters(activeLetters, perCol){
      const columns = buildColumnsForLetters(activeLetters);
      const initialMap = (()=>{const m=new Map(); for(const f of imageFiles){(m.get(f.initial)||m.set(f.initial,[]).get(f.initial)).push(f);} return m;})();
      const everything = [...imageFiles];

      const pickNoRepeat = (arr, n) => {
        const pool = arr.filter(x=>!usedSet.has(`${x.path}`));
        pool.sort(()=>Math.random()-0.5);
        const chosen = pool.slice(0,n);
        if(chosen.length < n){
          const more = arr.filter(x=>!chosen.includes(x));
          more.sort(()=>Math.random()-0.5);
          chosen.push(...more.slice(0, n - chosen.length));
        }
        return chosen;
      };

      const cards = [];
      for(const col of columns){
        let picks=[];
        if(col.key.startsWith('not-')){
          const L = col.key.slice(4);
          const notList = everything.filter(f => f.initial !== L);
          picks = pickNoRepeat(notList, perCol);
        } else {
          const L = col.key;
          const list = initialMap.get(L) || [];
          picks = pickNoRepeat(list, perCol);
        }
        for(const f of picks){ usedSet.add(`${f.path}`); }
        for(const f of picks){
          const audioUrl = audioMap.get(f.core) || null;
          cards.push({ id: crypto.randomUUID(), file: f.name, word: f.stem, imgUrl: f.url, audioUrl });
        }
      }
      return { columns, cards };
    }

    function buildRoundFromSyllables(sylls, perCol){
      const columns = buildColumnsForSyllables(sylls);
      const cards = [];

      const pickNoRepeat = (arr, n) => {
        const pool = arr.filter(x=>!usedSet.has(`${x.path}`));
        pool.sort(()=>Math.random()-0.5);
        const chosen = pool.slice(0,n);
        if(chosen.length < n){
          const more = arr.filter(x=>!chosen.includes(x));
          more.sort(()=>Math.random()-0.5);
          chosen.push(...more.slice(0, n - chosen.length));
        }
        return chosen;
      };

      for(const col of columns){
        const targetSyl = col.key.slice(5);
        const list = imageFiles.filter(f => firstSyllableNormalized(f.core) === targetSyl);
        const picks = pickNoRepeat(list, perCol);
        for(const f of picks){ usedSet.add(`${f.path}`); }
        for(const f of picks){
          const audioUrl = audioMap.get(f.core) || null;
          cards.push({ id: crypto.randomUUID(), file: f.name, word: f.stem, imgUrl: f.url, audioUrl });
        }
      }
      return { columns, cards };
    }

    function buildRoundFromWordList(activeLetters, sylls, wordsList){
      const columns = (sylls && sylls.length)
        ? buildColumnsForSyllables(sylls)
        : buildColumnsForLetters(activeLetters);

      const coreIndex = new Map();
      for(const f of imageFiles){ if(!coreIndex.has(f.core)) coreIndex.set(f.core, f); }

      const cards = [];
      for(const wRaw of wordsList){
        const wNorm = normalizeMarkers(wRaw);
        const f = coreIndex.get(wNorm);
        if(!f) continue;
        const audioUrl = audioMap.get(f.core) || null;
        cards.push({ id: crypto.randomUUID(), file: f.name, word: f.stem, imgUrl: f.url, audioUrl });
      }
      return { columns, cards };
    }

    function setOneRowGrid(colsCount){
      columnsEl.style.gridTemplateColumns = `repeat(${colsCount}, minmax(140px, 1fr))`;
    }

    function renderHeaderHTML(col){
      if (col.key.startsWith('syll:')) {
        if (HIDE_TITLE) return '';
        const text = (col.display || '').toLowerCase();
        return `<div class="syllTile" aria-hidden="true">${text}</div>`;
      }
      return `<h2>${col.label}</h2>`;
    }

    function buildColumns(columns){
      currentCols = columns;
      columnsEl.innerHTML='';
      setOneRowGrid(columns.length);
      columns.forEach((c, idx)=>{
        const col = document.createElement('div');
        col.className='col';
        col.innerHTML = `
          <header>${renderHeaderHTML(c)}</header>
          <div class="drop" data-col="${idx}"></div>`;
        columnsEl.appendChild(col);
      });
      const per = Math.max(1, Math.min(8, parseInt(cardsPerColEl.value||'4',10)));
      document.body.classList.toggle('one-per', per === 1);
    }

    function setCards(cards){
      currentCards = [...cards];
      rackEl.innerHTML='';
      const ordered = (new URLSearchParams(location.search).get('words')||'').length ? [...currentCards] : currentCards.sort(()=>Math.random()-0.5);
      ordered.forEach(card=> rackEl.appendChild(renderCard(card)) );

      // ðŸ”Š Preload only the audio needed for this round
      preloadAudioForCurrentCards();
    }

    let lastDragEndedAt = 0;

    function renderCard(card){
      const el=document.createElement('div');
      el.className='card';
      el.dataset.id=card.id;
      el.setAttribute('tabindex','0');
      // lazy/async helps with interactivity
      el.innerHTML = `<img alt="" src="${card.imgUrl}" loading="lazy" decoding="async"/><div class="cap">&nbsp;</div>`;

      // Audio click: use preloaded URL; fallback to resolve once if missing
      el.addEventListener('click', async ()=>{
        if (Date.now() - lastDragEndedAt < 150) return;
        const core = coreFromAudioStem(card.word || '');
        let url = audioMap.get(core);
        if (!url) {
          url = await resolveAudioForCore(core);
          if (url) audioMap.set(core, url);
        }
        if (url) {
          const a = new Audio(url);
          try { a.play(); } catch {}
        }
      });

      makeDraggable(el);
      return el;
    }

    function clearAllPlacements(){
      document.querySelectorAll('.drop').forEach(d=>d.innerHTML='');
      rackEl.innerHTML='';
      const ordered = (new URLSearchParams(location.search).get('words')||'').length ? [...currentCards] : currentCards.sort(()=>Math.random()-0.5);
      ordered.forEach(card=> rackEl.appendChild(renderCard(card)) );
    }
    function resetRoundPlacements(){
      document.querySelectorAll('.card').forEach(c=> c.classList.remove('ok','bad','locked') );
      clearAllPlacements();
    }

    /* Confetti: slightly faster than medium */
    function celebrate(){
      const cvs = document.createElement('canvas');
      cvs.className = 'celebrationCanvas';
      document.body.appendChild(cvs);
      const ctx = cvs.getContext('2d');
      let W, H, t0;
      const N = 180;
      const parts = [];
      function resize(){ W=window.innerWidth; H=window.innerHeight; cvs.width=W; cvs.height=H; }
      window.addEventListener('resize', resize); resize();

      for(let i=0;i<N;i++){
        parts.push({
          x: Math.random()*W,
          y: -20-Math.random()*H*0.2,
          vx: (-0.9 + Math.random()*1.8),
          vy: 2.0 + Math.random()*2.1,   // a bit faster than before
          rot: Math.random()*Math.PI,
          vr: (-0.22 + Math.random()*0.44),
          size: 5 + Math.random()*6,
          hue: Math.floor(Math.random()*360)
        });
      }

      function tick(ts){
        if(!t0) t0=ts;
        const dt = Math.min(32, ts - t0); t0 = ts;

        ctx.clearRect(0,0,W,H);
        parts.forEach(p=>{
          const gravity = 0.011;          // slightly stronger than before
          const drag    = 0.004;
          p.vy += gravity * (dt/16);
          p.vx *= (1 - drag);
          p.vy *= (1 - drag*0.6);
          p.x += p.vx * (dt/16);
          p.y += p.vy * (dt/16);
          p.rot += p.vr * (dt/16);

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = `hsl(${p.hue} 80% 55%)`;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
          ctx.restore();
        });

        if (parts.every(p=>p.y > H+30)) {
          document.body.removeChild(cvs);
          window.removeEventListener('resize', resize);
        } else { requestAnimationFrame(tick); }
      }
      requestAnimationFrame(tick);
    }

    function everythingCorrect(){
      const inRack = rackEl.querySelectorAll('.card').length;
      if(inRack>0) return false;
      const anyBad = document.querySelector('.drop .card.bad');
      if(anyBad) return false;
      const placed = document.querySelectorAll('.drop .card').length;
      const locked = document.querySelectorAll('.drop .card.locked').length;
      return placed>0 && placed===locked;
    }

    function verifyNow(fromBroadcast){
      const getTarget = key => {
        if (key.startsWith('not-')) return {type:'not', letter:key.slice(4)};
        if (key.startsWith('syll:')) return {type:'syll', syll:key.slice(5)};
        return {type:'is', letter:key};
      };

      document.querySelectorAll('.drop').forEach((drop, idx)=>{
        const target = getTarget(currentCols[idx].key);
        [...drop.children].forEach(cardEl=>{
          const card = currentCards.find(c=>c.id===cardEl.dataset.id);
          if(!card) return;

          const core = card.word || '';
          const coreNorm = normalizeMarkers(core);

          let ok = false;
          if (target.type === 'syll') {
            const firstSyl = firstSyllableNormalized(core);
            ok = (firstSyl === target.syll);
          } else {
            const initial = initialFromStem(coreNorm);
            ok = (target.type==='is') ? (initial===target.letter) : (initial!==target.letter);
          }

          if(ok){ cardEl.classList.add('ok','locked'); lockCard(cardEl, card); }
          else { cardEl.classList.add('bad'); setTimeout(()=> ejectToRack(cardEl), 350); }
        });
      });

      if (everythingCorrect()) celebrate();
      if (!fromBroadcast && isTeacher && channel){
        channel.send({ type:'broadcast', event:'VERIFY' });
      }
    }

    // ----- DnD (fixed-size during drag) -----
    let drag=null;
    function makeDraggable(el){
      el.style.touchAction='none';
      el.addEventListener('pointerdown', onGrab);
    }
    function onGrab(e){
      e.preventDefault();
      const el=e.currentTarget;
      if(el.classList.contains('locked')) return;
      drag={
        el,
        originParent:el.parentElement,
        pointerId:e.pointerId,
        startX:e.clientX, startY:e.clientY,
        moved:false
      };
      el.classList.add('dragging');            // fixed size while dragging
      el.setPointerCapture(e.pointerId);
      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('pointerup', onDrop, {passive:false});
      window.addEventListener('pointercancel', onCancel, {passive:false});
    }
    function onMove(e){
      if(!drag || e.pointerId!==drag.pointerId) return;
      e.preventDefault();
      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;
      if(!drag.moved && Math.hypot(dx,dy) < 4) return;
      if(!drag.moved){
        drag.moved = true;
        drag.el.style.position='fixed';
        drag.el.style.width = '150px';
        drag.el.style.height = '';
        drag.el.style.zIndex=1000;
        drag.el.style.pointerEvents='none';
      }
      drag.el.style.left=(e.clientX-70)+'px';
      drag.el.style.top =(e.clientY-70)+'px';
    }
    function onDrop(e){
      if(!drag || e.pointerId!==drag.pointerId) return;
      cleanupPointer(e.pointerId);
      const el=drag.el;

      if(!drag.moved){
        resetDraggedStyles(el);
        drag=null;
        return;
      }

      resetDraggedStyles(el);

      const drop = hitTestDrop(e.clientX, e.clientY);
      const perCol = Math.max(1, Math.min(8, parseInt(cardsPerColEl.value||'4',10)));
      document.body.classList.toggle('one-per', perCol === 1);

      if(drop){
        if(drop.children.length>=perCol){ drag.originParent.appendChild(el); }
        else { drop.appendChild(el); }
      } else {
        rackEl.appendChild(el);
      }
      lastDragEndedAt = Date.now();
      drag=null;
    }
    function onCancel(e){
      if(!drag || e.pointerId!==drag.pointerId) return;
      cleanupPointer(e.pointerId);
      resetDraggedStyles(drag.el);
      drag=null;
    }
    function cleanupPointer(pointerId){
      try{ drag.el.releasePointerCapture(pointerId);}catch(_){}
      drag.el.classList.remove('dragging');
      window.removeEventListener('pointermove', onMove);
      window.removeEventListener('pointerup', onDrop);
      window.removeEventListener('pointercancel', onCancel);
    }
    function resetDraggedStyles(el){
      el.classList.remove('dragging');
      el.style.position=''; el.style.left=''; el.style.top=''; el.style.zIndex=''; el.style.pointerEvents='';
      el.style.width=''; el.style.height='';
    }
    function hitTestDrop(x, y){
      const drops = Array.from(document.querySelectorAll('.drop'));
      for(const d of drops){
        const r = d.getBoundingClientRect();
        if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) return d;
      }
      return null;
    }
    function ejectToRack(cardEl){ cardEl.classList.remove('bad'); rackEl.appendChild(cardEl); }
    function lockCard(cardEl, card){
      const clone = cardEl.cloneNode(true);
      clone.classList.add('locked');
      // Keep audio tap on locked version as well
      clone.addEventListener('click', async ()=>{
        const core = coreFromAudioStem(card.word || '');
        let url = audioMap.get(core);
        if (!url) {
          url = await resolveAudioForCore(core);
          if (url) audioMap.set(core, url);
        }
        if (url) { const a = new Audio(url); try { a.play(); } catch {} }
      });
      cardEl.replaceWith(clone);
    }

    /******** Controls wiring ********/
    document.getElementById('btnVerify').addEventListener('click', ()=> verifyNow(false));
    document.getElementById('btnReset').addEventListener('click', resetRoundPlacements);
    soloVerifyBtn.addEventListener('click', ()=> verifyNow(false));
    soloResetBtn.addEventListener('click', resetRoundPlacements);
    inlineVerifyBtn.addEventListener('click', ()=> verifyNow(false));
    inlineResetBtn.addEventListener('click', resetRoundPlacements);

    btnNewRound.addEventListener('click', async ()=>{
      if(!isTeacher) return;
      if(imageFiles.length===0){
        await ensureStorageLoaded();
        if(imageFiles.length===0){ alert('No hay imÃ¡genes disponibles en Storage.'); return; }
      }
      const hasSyll = SOLO_SYLLABLES.length > 0;
      const activeLetters = hasSyll ? [] : [...letterPicker.querySelectorAll('.active')].map(b=>b.textContent);
      if(!hasSyll && activeLetters.length===0){ alert('Seleccione 1â€“5 letras.'); return; }
      const perCol = Math.max(1, Math.min(8, parseInt(cardsPerColEl.value||'4',10)));
      const useWords = SOLO_WORDS.length > 0;

      const payload =
        useWords
          ? buildRoundFromWordList(activeLetters, SOLO_SYLLABLES, SOLO_WORDS)
          : (hasSyll
              ? buildRoundFromSyllables(SOLO_SYLLABLES, perCol)
              : buildRoundFromLetters(activeLetters, perCol));

      await channel.send({ type:'broadcast', event:'ROUND', payload });
    });

    // SOLO MODE
    function startSoloRound(){
      usedSet = new Set();
      const hasSyll = SOLO_SYLLABLES.length > 0;
      const per = SOLO_PER || 4;
      document.body.classList.toggle('one-per', per === 1);

      let payload;
      if (SOLO_WORDS.length > 0) {
        payload = buildRoundFromWordList(hasSyll ? [] : SOLO_LETTERS, SOLO_SYLLABLES, SOLO_WORDS);
      } else if (hasSyll) {
        payload = buildRoundFromSyllables(SOLO_SYLLABLES, per);
      } else {
        payload = buildRoundFromLetters(SOLO_LETTERS, per);
      }

      buildColumns(payload.columns);
      setCards(payload.cards);
      clearAllPlacements();
    }

    (async function boot(){
      if (SOLO_MODE) {
        setPanelsForSolo();
        await ensureStorageLoaded();
        if(imageFiles.length===0) return;

        soloNewRoundBtn.addEventListener('click', ()=> startSoloRound());
        startSoloRound();
        return;
      }

      // default (teacher/student UI)
      modeToggle.checked = false;
      isTeacher = false;
      teacherPanel.classList.add('hidden');
      studentPanel.classList.remove('hidden');
    })();
  </script>
</body>
</html>
