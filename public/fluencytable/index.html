<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SlideToRead ‚Äî Fluency</title>

<style>
body {
  margin: 0;
  font-family: Andika, system-ui, sans-serif;
  background: #f8fafc;
}

header {
  padding: 10px 16px;
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  gap: 10px;
  align-items: center;
}

header h1 {
  font-size: 18px;
  margin: 0;
}

header .spacer { flex: 1; }

button {
  font-size: 15px;
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  background: #2563eb;
  color: #fff;
  cursor: pointer;
}

main {
  padding: 24px;
  display: flex;
  justify-content: center;
}

.table {
  display: grid;
  gap: 14px;
  max-width: 900px;
  width: 100%;
}

.box {
  position: relative;
  height: 72px;
  border-radius: 14px;
  border: 2px solid #111827;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  overflow: hidden;
}

.word { z-index: 1; }

.mask {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.8);
  transform: translateX(-100%);
  pointer-events: none;
  z-index: 2;
}
</style>
</head>

<body>

<header>
  <h1 id="title">Fluidez</h1>
  <div class="spacer"></div>
  <button id="shuffleBtn" hidden>üîÄ Nueva tabla</button>
  <button id="sweepBtn">‚ñ∂Ô∏è Iniciar</button>
</header>

<main>
  <div id="table" class="table"></div>
</main>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

/* ================= CONFIG ================= */

const SUPABASE_URL = 'https://dmlsiyyqpcupbizpxwhp.supabase.co';
const SUPABASE_ANON_KEY =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbHNpeXlxcGN1cGJpenB4d2hwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MDI1NjUsImV4cCI6MjA3Mzk3ODU2NX0.mkgeUtjC8ulLyHHVVOic4LmhhQP_JJtMi2JQztdzjsg';

const PRESETS_URL =
  'https://dmlsiyyqpcupbizpxwhp.supabase.co/storage/v1/object/public/app-presets/fluency/presets.json';

/* ================= URL PARAMS ================= */

const qs = new URLSearchParams(location.search);
const PRESET_ID = qs.get('preset');
const IS_TEACHER = qs.get('role') === 'teacher';

if (!PRESET_ID) {
  document.body.innerHTML = '<h2 style="padding:20px">‚ùå Missing preset</h2>';
  throw new Error('Missing preset');
}

/* ================= SUPABASE ================= */

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= DOM ================= */

const tableEl = document.getElementById('table');
const shuffleBtn = document.getElementById('shuffleBtn');
const sweepBtn = document.getElementById('sweepBtn');
const titleEl = document.getElementById('title');

if (IS_TEACHER) shuffleBtn.hidden = false;

/* ================= STATE ================= */

let PRESET;
let ROWS, COLS, SWEEP_MS, CONTENT;
let currentRow = 0;

/* ================= UTIL ================= */

function seededShuffle(arr, seed) {
  let x = seed;
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    x = (x * 16807) % 2147483647;
    const j = x % (i + 1);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ================= TABLE ================= */

function buildTable(seed) {
  currentRow = 0;
  tableEl.innerHTML = '';
  tableEl.style.gridTemplateColumns = `repeat(${COLS}, 1fr)`;

  const total = ROWS * COLS;
  let pool = [];
  let s = seed;

  while (pool.length < total) {
    pool.push(...seededShuffle(CONTENT, s++));
  }

  pool.slice(0, total).forEach(text => {
    const box = document.createElement('div');
    box.className = 'box';

    const word = document.createElement('div');
    word.className = 'word';
    word.textContent = text;

    const mask = document.createElement('div');
    mask.className = 'mask';

    box.append(word, mask);
    tableEl.appendChild(box);
  });
}

/* ================= SWEEP ================= */

async function sweepRow(rowIndex) {
  const start = rowIndex * COLS;
  const end = start + COLS;
  const boxes = document.querySelectorAll('.box');

  for (let i = start; i < end; i++) {
    const mask = boxes[i]?.querySelector('.mask');
    if (!mask) continue;

    // reset (just in case)
    mask.style.transition = 'none';
    mask.style.transform = 'translateX(-100%)';
    mask.getBoundingClientRect(); // force reflow

    // animate
    mask.style.transition = `transform ${SWEEP_MS}ms linear`;
    mask.style.transform = 'translateX(0%)';

    // ‚è±Ô∏è wait before next tile
    await new Promise(r => setTimeout(r, SWEEP_MS));
  }
}

/* ================= INIT ================= */

async function init() {
  const presetRes = await fetch(PRESETS_URL, { cache: 'no-store' });
  const allPresets = await presetRes.json();
  PRESET = allPresets[PRESET_ID];

  if (!PRESET) {
    document.body.innerHTML = `<h2 style="padding:20px">‚ùå Preset not found</h2>`;
    return;
  }

  ROWS = PRESET.rows;
  COLS = PRESET.cols;
  SWEEP_MS = PRESET.sweep_ms;
  CONTENT = PRESET.content.filter(Boolean);

  titleEl.textContent = PRESET.title || 'Fluidez';

  const { data } = await supabase
    .from('fluency_sessions')
    .select('*')
    .eq('lesson_id', PRESET_ID)
    .single();

  if (!data) return;

  buildTable(Number(data.seed));

  supabase
    .channel('fluency')
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'fluency_sessions',
        filter: `lesson_id=eq.${PRESET_ID}`
      },
      payload => {
        buildTable(Number(payload.new.seed));
      }
    )
    .subscribe();

  sweepBtn.onclick = () => {
    if (currentRow >= ROWS) return;
    sweepRow(currentRow);
    currentRow++;
  };

  if (IS_TEACHER) {
    shuffleBtn.onclick = async () => {
      await supabase
        .from('fluency_sessions')
        .update({ seed: Date.now() })
        .eq('lesson_id', PRESET_ID);
    };
  }
}

init();
</script>

</body>
</html>
